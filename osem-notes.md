# OSEM

## Initial Setup

* Create a heroku app – I left the name blank and got [`intense-shore-93790`](https://intense-shore-93790.herokuapp.com/) assigned

* Clone the app and add the heroku remote

    $ git clone git@github.com:openSUSE/osem.git
    $ heroku login
    $ heroku git:remote -a intense-shore-93790

* Set some of the documented env vars
  * https://github.com/openSUSE/osem/blob/master/app.json
  * https://github.com/openSUSE/osem/blob/master/INSTALL.md#configure

    $ heroku config:set CLOUDINARY_URL="cloudinary://**********:**********@rcms/"
    $ heroku config:set OSEM_HOSTNAME="intense-shore-93790.herokuapp.com"
    $ heroku config:set OSEM_ICHAIN_ENABLED="false"
    $ heroku config:set OSEM_NAME="Steph's OSEM"
    $ heroku config:set RACK_ENV="production"
    $ heroku config:set RAILS_ENV="production"

    # You can generate this in rails apps with `rake secret`
    # I just used an existing rails app to generate one, as I didn't get OSEM
    # running locally. Just needs to be a strong password (128 chars)
    $ heroku config:set SECRET_KEY_BASE="**********"

    # In real-production you probably want this to be off and use a CDN instead
    $ heroku config:set RAILS_SERVE_STATIC_FILES="enabled"

    # I don't think this one is actually needed, but it was added in the deploy
    # button configuration
    $ heroku config:set DEPLOY_TASKS="db:cleardb_env"

* Provision ClearDB and Sendgrid free plans through the web interface. This
  automatically sets the credentials in the environment, but you need to copy
  them over to OSEM-specific env vars.

* Configure the database through the env (https://devcenter.heroku.com/articles/cleardb#configuring-your-ruby-application-to-use-cleardb)

    # Get the cleardb-provided database URL
    $ heroku config | grep CLEARDB_DATABASE_URL
    CLEARDB_DATABASE_URL:     mysql://**********:937879ee@eu-cdbr-west-01.cleardb.com/heroku_**********?reconnect=true

    # Set the Heroku DATABASE_URL env – this is what configures the DB
    # Need to change from mysql:// to mysql2://
    $ heroku config:set DATABASE_URL="mysql2://**********:937879ee@eu-cdbr-west-01.cleardb.com/heroku_**********?reconnect=true"

* Run migrations `$ heroku run rake db:migrate`

* Set up SendGrid (https://devcenter.heroku.com/articles/sendgrid#actionmailer)

    # Get the SendGrid credentials
    $ heroku config:get SENDGRID_USERNAME
    $ heroku config:get SENDGRID_PASSWORD

    # Set OSEM config
    $ heroku config:set OSEM_SMTP_ADDRESS="smtp.sendgrid.net"
    $ heroku config:set OSEM_SMTP_PORT="587"
    $ heroku config:set OSEM_SMTP_USERNAME="**********@heroku.com"
    $ heroku config:set OSEM_SMTP_PASSWORD="**********"
    $ heroku config:set OSEM_SMTP_AUTHENTICATION=plain
    $ heroku config:set OSEM_SMTP_DOMAIN=intense-shore-93790.herokuapp.com

* Set a better no-reply email address

    $ heroku config:set OSEM_EMAIL_ADDRESS="no-reply@intense-shore-93790.herokuapp.com"

* Set up Stripe

    # Generate Test API keys in the dashboard and enable "full test mode"
    $ heroku config:set STRIPE_PUBLISHABLE_KEY="pk_test_**********"
    $ heroku config:set STRIPE_SECRET_KEY="sk_test_**********"

* For whatever reason, Stripe config doesn't fall back to using the
  env-configured values. It only imports them through `config/secrets.yml`,
  which is ignored. This doesn't get copied across or generated by Heroku, so
  we need to check the file in, and get it to pull the values we need from the
  env.
* Check in `config/secrets.yml` with `ENV`-based configuration

    commit a62f8a8a4a219df0f4d630df45e237be2d8e63fc
    Author: Gareth Rees <gareth@garethrees.co.uk>
    Date:   Sat Jul 8 12:21:34 2017 +0100

        Check in secrets.yml with ENV-based config

        The app uses `Rails.application.secrets.stripe_publishable_key`, so
        there doesn't seem to be another way of setting this on Heroku without
        checking this file in.

    diff --git a/.gitignore b/.gitignore
    index 4d5fd42..6a4df87 100644
    --- a/.gitignore
    +++ b/.gitignore
    @@ -1,7 +1,6 @@
     /db/test.sqlite3-journal
     config/application.rb
     config/config.yml
    -config/secrets.yml
     config/database.yml
     config/piwik.yml
     /vendor/cache
    diff --git a/config/secrets.yml b/config/secrets.yml
    new file mode 100644
    index 0000000..e4cd4a5
    --- /dev/null
    +++ b/config/secrets.yml
    @@ -0,0 +1,73 @@
    +development:
    +  # Generate your own with rake secret
    +  # secret_key_base: '12345'
    +
    +  ########## OMNIAUTH Providers ##########
    +  # This is just sample data so mocks work
    +  google_key: 'sample'
    +  google_secret: 'sample'
    +
    +  facebook_key: 'sample'
    +  facebook_secret: 'sample'
    +
    +  suse_key: 'sample'
    +  suse_secret: 'sample'
    +
    +  # Register on stripe and add TEST keys here
    +  # https://dashboard.stripe.com/account/apikeys
    +  stripe_publishable_key: <%= ENV['STRIPE_PUBLISHABLE_KEY'] %>
    +  stripe_secret_key: <%= ENV['STRIPE_SECRET_KEY'] %>
    +
    +test:
    +  # Generate your own with rake secret
    +  # secret_key_base: '12345'
    +
    +  # Register on stripe and add TEST keys here
    +  # https://dashboard.stripe.com/account/apikeys
    +  stripe_publishable_key: <%= ENV['STRIPE_PUBLISHABLE_KEY'] %>
    +  stripe_secret_key: <%= ENV['STRIPE_SECRET_KEY'] %>
    +
    +production:
    +  # Generate your own with rake secret or use the environment
    +  # secret_key_base: <%= ENV["SECRET_KEY_BASE"] %>
    +
    +  # Your errbit API key
    +  errbit_key: <%= ENV['ERRBIT_APIKEY'] %>
    +
    +  ########## OMNIAUTH Providers ##########
    +  # Leave the variables' names empty, unless you use the providers, in which
    +  # case you need to register your applicaton and add the actual keys.
    +  #
    +  # If you add a provider, keep the format of the variables:
    +  # *provider*_key and *provider*_secret
    +
    +  # If you add a provider that does not require a key, you still have to
    +  # create the 2 variables with sample data or they won't show up in the app.
    +
    +  # Register your appllication with Google from
    +  # https://code.google.com/apis/console#:access
    +  google_key: <%= ENV['OSEM_GOOGLE_KEY'] %>
    +  google_secret: <%= ENV['OSEM_GOOGLE_SECRET'] %>
    +
    +  # Register your application with Facebook from
    +  # https://developers.facebook.com/
    +  facebook_key: <%= ENV['OSEM_FACEBOOK_KEY'] %>
    +  facebook_secret: <%= ENV['OSEM_FACEBOOK_SECRET'] %>
    +
    +  # Developers do not need to register their application for suse account to
    +  # work. You must, however, add some sample value to the variables, for the
    +  # login option to appear. For example:
    +  #suse_key: 'sample data'
    +  #suse_secret: 'sample data'
    +  suse_key: <%= ENV['OSEM_SUSE_KEY'] %>
    +  suse_secret: <%= ENV['OSEM_SUSE_SECRET'] %>
    +
    +  # Register your application with GitHub from
    +  # https://github.com/settings/applications
    +  github_key: <%= ENV['OSEM_GITHUB_KEY'] %>
    +  github_secret: <%= ENV['OSEM_GITHUB_SECRET'] %>
    +
    +  # Register on stripe and add LIVE keys here
    +  # https://dashboard.stripe.com/account/apikeys
    +  stripe_publishable_key: <%= ENV['STRIPE_PUBLISHABLE_KEY'] %>
    +  stripe_secret_key: <%= ENV['STRIPE_SECRET_KEY'] %>

* Push these changes:

    $ git push heroku master


